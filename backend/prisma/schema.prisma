datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==================== ENUMS ====================

enum MediaType {
  IMAGE
  VIDEO
}

enum UserRole {
  GUEST
  UNVERIFIED
  USER
  TRUSTED
  MODERATOR
  ADMIN
}

enum RestrictionType {
  UPLOAD_BAN
  COMMENT_BAN
  RATING_BAN
  REPORT_BAN
  FULL_BAN
}

enum RestrictionReason {
  SPAM
  COPYRIGHT
  ILLEGAL_CONTENT
  HARASSMENT
  EXPLICIT_CONTENT
  OTHER
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CommentDeletedKind {
  USER
  MODERATOR
}

// ==================== USERS ====================

model User {
  id        String    @id @default(uuid())
  username  String    @unique
  email     String    @unique
  password  String    @map("password_hash")
  role      UserRole  @default(UNVERIFIED)
  birthDate DateTime?

  avatarKey String?
  bio       String?
  website   String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  emailVerifiedAt DateTime?
  deletedAt       DateTime?

  showComments  Boolean @default(true)
  showRatings   Boolean @default(true)
  showFavorites Boolean @default(true)
  showUploads   Boolean @default(true)

  uploadCount  Int @default(0)
  warningCount Int @default(0)

  isBanned Boolean @default(false)

  comments    Comment[]
  ratings     Rating[]
  media       Media[]       @relation("UserUploads")
  favorites Favorite[]
  viewHistory ViewHistory[]

  reports         Report[] @relation("UserReports")
  assignedReports Report[] @relation("ReportsAssignedTo")
  resolvedReports Report[] @relation("ReportResolvedBy")

  restrictions        Restriction[] @relation("UserRestrictions")
  issuedRestrictions  Restriction[] @relation("RestrictionIssuedBy")
  revokedRestrictions Restriction[] @relation("RestrictionRevokedBy")

  warnings       Warning[] @relation("UserWarnings")
  issuedWarnings Warning[] @relation("WarningsIssuedBy")

  moderatedMedia Media[]         @relation("MediaModeratedBy")
  moderationLogs ModerationLog[]

  blockedHashes BlockedHash[]  @relation("BlockedHashesByUser")
  tagHistory    TagHistory[]   @relation("TagHistoryByUser")
  notifications Notification[] @relation("UserNotifications")
  UserQuota     UserQuota[]

  @@index([createdAt])
  @@index([role])
  @@index([deletedAt])
  @@index([isBanned])
}

// ==================== QUOTAS ====================

model UserQuota {
  id               String    @id @default(uuid())
  userId           String
  quotaType        String
  limitValue       Int
  currentValue     Int       @default(0)
  resetInterval    String?
  nextResetAt      DateTime?
  overridesDefault Boolean   @default(false)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quotaType])
}

model RoleQuota {
  id        String   @id @default(uuid())
  role      UserRole @unique
  quotas    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== RESTRICTIONS & WARNINGS ====================

model Restriction {
  id           String            @id @default(uuid())
  userId       String
  type         RestrictionType
  reason       RestrictionReason
  customReason String?
  details      String?
  expiresAt    DateTime?
  isActive     Boolean           @default(true)
  issuedById   String
  revokedById  String?
  issuedAt     DateTime          @default(now())
  revokedAt    DateTime?

  user      User  @relation("UserRestrictions", fields: [userId], references: [id], onDelete: Cascade)
  issuedBy  User  @relation("RestrictionIssuedBy", fields: [issuedById], references: [id])
  revokedBy User? @relation("RestrictionRevokedBy", fields: [revokedById], references: [id])
}

model Warning {
  id           String    @id @default(uuid())
  userId       String
  issuedById   String
  severity     Int       @default(1)
  reason       String
  details      String?
  acknowledged Boolean   @default(false)
  expiresAt    DateTime?
  issuedAt     DateTime  @default(now())

  user     User @relation("UserWarnings", fields: [userId], references: [id], onDelete: Cascade)
  issuedBy User @relation("WarningsIssuedBy", fields: [issuedById], references: [id])
}

// ==================== BLOCKED HASHES ====================

model BlockedHash {
  id          String   @id @default(uuid())
  hash        String   @unique
  reason      String
  blockedById String
  blockedAt   DateTime @default(now())
  notes       String?

  blockedBy User @relation("BlockedHashesByUser", fields: [blockedById], references: [id])
}

// ==================== MEDIA ====================

model Media {
  id          String  @id @default(uuid())
  originalKey String
  previewKey  String?
  randomKey   Float   @default(dbgenerated("random()")) @db.DoublePrecision
  hash        String  @unique
  contentType String
  size        Int

  width    Int?
  height   Int?
  duration Int?

  description String?
  type        MediaType
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  commentCount Int @default(0)

  moderationStatus ModerationStatus @default(PENDING)
  moderatedAt      DateTime?
  moderatedById    String?
  moderationNotes  String?
  isExplicit       Boolean          @default(false)

  // ===== Rating denormalization =====
  ratingCount Int   @default(0)
  ratingSum   Int   @default(0)
  ratingAvg   Float @default(0) @db.DoublePrecision

  deletedAt DateTime?
  deletedBy String?

  uploadedBy   User?   @relation("UserUploads", fields: [uploadedById], references: [id])
  uploadedById String?
  moderatedBy  User?   @relation("MediaModeratedBy", fields: [moderatedById], references: [id])

  tagLinks    MediaTags[]
  comics      ComicPage[]
  comments    Comment[]
  ratings     Rating[]
  favorites Favorite[]
  viewHistory ViewHistory[]

  @@index([randomKey])
  @@index([commentCount])

  // Для сортировок:
  @@index([ratingAvg])
  @@index([ratingCount])
}

// ==================== MEDIA TAGS ====================

model MediaTags {
  mediaId String
  tagId   String
  addedAt DateTime @default(now())

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  tag   Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([mediaId, tagId])
  @@index([tagId, mediaId])
}

// ==================== COMICS ====================

model Comic {
  id        String   @id @default(uuid())
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pages ComicPage[]
}

model ComicPage {
  id       String @id @default(uuid())
  comicId  String
  mediaId  String
  position Int

  comic Comic @relation(fields: [comicId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([comicId, position])
}

// ==================== TAGS ====================

model TagCategory {
  id    String @id @default(uuid())
  name  String @unique
  color String

  tags Tag[]
}

model Tag {
  id         String @id @default(uuid())
  name       String @unique
  categoryId String
  usageCount Int    @default(0)

  customColor String? // HEX override, например "#FF00AA"

  category   TagCategory  @relation(fields: [categoryId], references: [id])
  mediaLinks MediaTags[]
  aliases    TagAlias[]
  history    TagHistory[]

  @@index([name])
  @@index([usageCount])
}


model TagAlias {
  id    String @id @default(uuid())
  alias String @unique
  tagId String

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)
}

model TagHistory {
  id     String  @id @default(uuid())
  tagId  String
  userId String?

  action   String
  oldValue String?
  newValue String?

  tag  Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)
  user User? @relation("TagHistoryByUser", fields: [userId], references: [id])
}

// ==================== COMMENTS ====================

model Comment {
  id       String  @id @default(uuid())
  content  String
  mediaId  String
  userId   String
  parentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt     DateTime?
  deletedById   String?
  deletedKind   CommentDeletedKind?
  deletedReason String?

  media   Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@index([mediaId])
  @@index([mediaId, deletedAt])
  @@index([parentId])
}

// ==================== RATINGS ====================

model Rating {
  id      String @id @default(uuid())
  value   Int
  mediaId String
  userId  String

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([mediaId, userId])
}

// ==================== VIEW HISTORY ====================

model ViewHistory {
  id      String  @id @default(uuid())
  userId  String?
  mediaId String

  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
}

// ==================== REPORTS ====================

model Report {
  id          String  @id @default(uuid())
  type        String
  targetId    String
  reason      String
  description String?
  status      String  @default("pending")

  reportedById String
  assignedToId String?
  resolvedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reportedBy User  @relation("UserReports", fields: [reportedById], references: [id])
  assignedTo User? @relation("ReportsAssignedTo", fields: [assignedToId], references: [id])
  resolvedBy User? @relation("ReportResolvedBy", fields: [resolvedById], references: [id])

  @@index([type, targetId, createdAt])
  @@index([status, createdAt])
  @@index([reportedById, createdAt])
}

// ==================== MODERATION LOGS ====================

model ModerationLog {
  id          String   @id @default(uuid())
  action      String
  targetType  String
  targetId    String
  moderatorId String

  details Json? // <── НОВОЕ

  createdAt DateTime @default(now())

  moderator User @relation(fields: [moderatorId], references: [id])

  @@index([targetType, targetId])
  @@index([moderatorId])
  @@index([createdAt])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id     String @id @default(uuid())
  userId String

  type    String
  title   String
  message String
  data    Json?
  isRead  Boolean @default(false)

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== FAVORITES ====================

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  mediaId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([userId, mediaId])
  @@index([userId, createdAt])
  @@index([mediaId, createdAt])
}
